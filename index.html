<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoRetrofit24 • Advanced MVP Prototype</title>
  <meta name="description" content="EcoRetrofit24 – APVA automation, retrofit workflow, KPI reporting, and AI insights (prototype)." />

  <!-- Link preview / PWA polish -->
  <meta property="og:title" content="EcoRetrofit24 – APVA & Retrofit MVP" />
  <meta property="og:description" content="Audit → Estimator → APVA PDF → Kanban → Reporting → AI insights." />
  <meta property="og:image" content="logo.png" />
  <meta name="theme-color" content="#0d9488" />

  <style>
    /* ===== Base ===== */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,Arial;background:#f8fafc;color:#1e293b;line-height:1.5}
    #root{min-height:100vh}

    /* ===== Header ===== */
    .header{display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid #e2e8f0;background:#fff;position:sticky;top:0;z-index:10}
    .logo-fallback{height:40px;width:40px;border-radius:10px;background:linear-gradient(135deg,#0d9488,#0891b2);color:#fff;display:grid;place-items:center;font-weight:700;font-size:18px}
    .title{font-size:20px;font-weight:600;color:#0f766e}
    .sub{font-size:13px;color:#64748b}
    .btn{border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:600;transition:all .2s;font-size:14px}
    .btn-primary{background:#0d9488;color:#fff;border:1px solid #0d9488}
    .btn-primary:hover{background:#0f766e;border-color:#0f766e}
    .btn-outline{background:#fff;color:#0d9488;border:1px solid #0d9488}
    .btn-outline:hover{background:#f0fdfa}
    .btn-ai{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;border:none}
    .btn-ai:hover{filter:brightness(0.95)}

    /* ===== Tabs ===== */
    .tab-bar{display:flex;gap:8px;padding:16px;background:#f1f5f9;border-bottom:1px solid #e2e8f0;flex-wrap:wrap}
    .tab{padding:10px 16px;border:1px solid #cbd5e1;background:#fff;border-radius:8px;cursor:pointer;transition:all .2s;font-size:14px;font-weight:500}
    .tab:hover{background:#f8fafc;border-color:#94a3b8}
    .tab-active{background:#0d9488;color:#fff;border-color:#0d9488}
    .ai-tab{background:linear-gradient(135deg,#8b5cf6,#ec4899);color:#fff;border:none}

    /* ===== Layout ===== */
    .content{padding:20px;max-width:1400px;margin:0 auto}
    .grid-3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #f1f5f9}
    .section-title{font-size:18px;font-weight:600;color:#0f766e}
    .label{font-size:13px;color:#64748b;margin-bottom:6px;font-weight:500}
    .input{width:100%;border:1px solid #cbd5e1;border-radius:8px;padding:10px 12px;font-size:14px;outline:none;transition:border-color .2s;font-family:inherit}
    .input:focus{border-color:#0d9488;box-shadow:0 0 0 3px rgba(13,148,136,.1)}
    textarea.input{min-height:100px;resize:vertical}
    .err{color:#dc2626;font-size:12px;margin-top:4px}

    .badge{display:inline-block;padding:4px 10px;background:#0d9488;color:#fff;border-radius:20px;margin-right:6px;font-size:12px;font-weight:600}
    .badge-light{display:inline-block;padding:4px 10px;background:#f1f5f9;color:#475569;border-radius:20px;font-size:12px;font-weight:600}
    .pill{padding:4px 10px;border-radius:999px;background:#ecfdf5;color:#065f46;border:1px solid #d1fae5;font-size:12px;font-weight:600}
    .list{font-size:14px;color:#475569;padding-left:20px;line-height:1.6}
    .muted{font-size:13px;color:#64748b;margin:0}

    .grid-apva{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    .steps-row{display:flex;align-items:center;gap:8px;margin-bottom:16px}
    .step-line{flex:1;height:2px;background:#cbd5e1}
    .box{border:1px solid #e2e8f0;border-radius:10px;padding:16px;background:#fff}

    .kanban{display:grid;grid-template-columns:repeat(6,1fr);gap:16px;overflow-x:auto;padding:8px 0}
    .kanban-col{border:1px solid #e2e8f0;border-radius:12px;padding:16px;background:#fff;min-width:220px}
    .kanban-col-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #f1f5f9}
    .card-sm{border:1px solid #e2e8f0;border-radius:10px;padding:14px;background:#fff;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .mini-text{margin-top:8px;font-size:12px;color:#64748b}

    .progress-outer{width:100%;height:8px;background:#f1f5f9;border-radius:10px;overflow:hidden;margin:10px 0}
    .progress-inner{height:100%;background:#0d9488;transition:width .3s;border-radius:10px}

    .footer{padding:20px;font-size:13px;color:#64748b;text-align:center;border-top:1px solid #e2e8f0;margin-top:30px;background:#f8fafc}

    .chart-container{height:260px;margin-top:10px}
    .btn-group{display:flex;gap:10px;margin-top:16px}

    .metric-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .metric-card{border:1px solid #e2e8f0;border-radius:10px;padding:14px;background:#fff}
    .metric-label{font-size:12px;color:#64748b;margin-bottom:6px}
    .metric-value{font-size:18px;font-weight:700;color:#0f766e}

    .ai-reco{background:linear-gradient(135deg,#fdf4ff,#f0f9ff);border:1px solid #e9d5ff;border-radius:10px;padding:16px;margin:16px 0}
    .ai-h{display:flex;align-items:center;gap:8px;margin-bottom:12px;color:#7e22ce;font-weight:600}
    .ai-pred{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin:16px 0}

    @media (max-width:1200px){.grid-3{grid-template-columns:1fr 1fr}.grid-3 .section:nth-child(3){grid-column:1/-1}.kanban{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:900px){.grid-3{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}.grid-apva{grid-template-columns:1fr}.kanban{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.header{flex-direction:column;text-align:center;gap:10px}.content{padding:16px}.kanban{grid-template-columns:1fr}}
  </style>

  <!-- React + ReactDOM + Recharts + jsPDF (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Babel for in-browser JSX (dev only) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;
    const R = window.Recharts || {};
    const { ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, PieChart, Pie, Cell, BarChart, Bar } = R;
    const { jsPDF } = window.jspdf;

    /* ===== UI primitives ===== */
    const Section = ({ title, action, children }) => (
      <div className="section">
        <div className="section-head">
          <div className="section-title">{title}</div>
          {action}
        </div>
        {children}
      </div>
    );

    const Pill = ({ children }) => <span className="pill">{children}</span>;

    const Field = ({ label, full, children }) => (
      <div style={{ gridColumn: full ? '1 / -1' : undefined }}>
        <div className="label">{label}</div>
        {children}
      </div>
    );

    const Progress = ({ value }) => (
      <div className="progress-outer"><div className="progress-inner" style={{ width: value + '%' }} /></div>
    );

    const Metric = ({ label, value }) => (
      <div className="metric-card">
        <div className="metric-label">{label}</div>
        <div className="metric-value">{value}</div>
      </div>
    );

    const Step = ({ done, label }) => (
      <div style={{ display:'flex', alignItems:'center', gap:6, color: done ? '#065f46' : '#9ca3af' }}>
        <div style={{ height:24, width:24, borderRadius:999, display:'grid', placeItems:'center', border:`1px solid ${done ? '#059669' : '#e5e7eb'}`, background: done ? '#059669' : '#fff', color: done ? '#fff' : '#6b7280', fontSize:12, fontWeight:700 }}>
          {done ? '✓' : label[0]}
        </div>
        <span style={{ fontSize:14 }}>{label}</span>
      </div>
    );

    /* ===== Extra components ===== */
    function HealthGauge({ value = 92 }){
      const data = [ { name:'health', value }, { name:'rest', value: 100 - value } ];
      return (
        <ResponsiveContainer width="100%" height={200}>
          <PieChart>
            <Pie data={data} dataKey="value" startAngle={90} endAngle={-270} innerRadius={60} outerRadius={80}>
              <Cell fill="#10b981" />
              <Cell fill="#eef2ff" />
            </Pie>
            <text x="50%" y="50%" textAnchor="middle" dominantBaseline="middle" style={{ fontSize:24, fontWeight:700 }}>{value}%</text>
          </PieChart>
        </ResponsiveContainer>
      );
    }

    function BatterySpotlight(){
      return (
        <div className="box" style={{ marginTop: 12 }}>
          <div style={{ fontSize:18, fontWeight:700 }}>EcoCell ECO-82</div>
          <div style={{ color:'#6b7280', fontSize:12 }}>LT-BAT-2024-001847 • Vilnius, LT</div>
          <div style={{ display:'grid', gridTemplateColumns:'1.2fr 1fr', gap:16, marginTop:12 }}>
            <div>
              <div style={{ display:'grid', gridTemplateColumns:'1fr 1fr', gap:12 }}>
                <div className="box"><div className="label">kWh Capacity</div><div style={{fontSize:22,fontWeight:700}}>82</div></div>
                <div className="box"><div className="label">% Health</div><div style={{fontSize:22,fontWeight:700}}>92</div></div>
              </div>
              <div style={{ marginTop:8, fontSize:13 }}>Digital Passport: <a href="#" style={{ color:'#2563eb' }}>PASS-2654</a></div>
            </div>
            <div className="box">
              <div style={{ fontWeight:600, marginBottom:8 }}>Battery Health</div>
              <HealthGauge value={92} />
            </div>
          </div>
        </div>
      );
    }

    /* ===== App ===== */
    function App(){
      const [activeTab, setActiveTab] = useState('audit');

      // deep-link tabs
      useEffect(() => {
        const h = window.location.hash.replace('#','');
        if ([ 'audit','apva','projects','reporting','ai' ].includes(h)) setActiveTab(h);
      }, []);
      useEffect(() => { window.location.hash = activeTab; }, [activeTab]);

      // audit form state + autosave (pre-filled so estimator/AI show data)
      const [audit, setAudit] = useState({
        buildingType:'Single',
        floorArea:'1,250',
        yearBuilt:'1998',
        heating:'Gas',
        annualKwh:'185,000',
        notes:'Double-glazed windows, minor roof thermal bridge.'
      });
      const [errors, setErrors] = useState({});
      useEffect(() => { const s = localStorage.getItem('eco_audit'); if (s) setAudit(JSON.parse(s)); }, []);
      useEffect(() => { localStorage.setItem('eco_audit', JSON.stringify(audit)); }, [audit]);

      const [apvaStatus, setApvaStatus] = useState('Draft');
      const [apvaPdfReady, setApvaPdfReady] = useState(false);
      const [apvaUrl, setApvaUrl] = useState(null);

      const demoProjects = [
        { id:1, addr:'125 Oak St.', stage:'Intake', pct:18 },
        { id:2, addr:'789 Birch Ave.', stage:'Audit', pct:42 },
        { id:3, addr:'790 Dack Ave.', stage:'Proposal', pct:58 },
        { id:4, addr:'123 Oak St.', stage:'Install', pct:76 },
        { id:5, addr:'781 5th Ave.', stage:'QC', pct:88 },
        { id:6, addr:'117 9th Ave.', stage:'Rebate', pct:100 },
      ];
      const stages = ['Intake','Audit','Proposal','Install','QC','Rebate'];

      const [projectQuery, setProjectQuery] = useState('');
      const filtered = useMemo(() => demoProjects.filter(p => p.addr.toLowerCase().includes(projectQuery.toLowerCase())), [projectQuery]);

      const kpiData = [
        { month:'Jan', savings:12, approvals:2 },
        { month:'Feb', savings:15, approvals:3 },
        { month:'Mar', savings:18, approvals:4 },
        { month:'Apr', savings:22, approvals:5 },
        { month:'May', savings:27, approvals:6 },
        { month:'Jun', savings:31, approvals:7 },
      ];

      const mix = [
        { name:'Solar', value:40 },
        { name:'Heat Pumps', value:32 },
        { name:'Insulation', value:18 },
        { name:'Batteries', value:10 },
      ];

      function validateAudit(a){
        const e = {};
        const num = v => Number(String(v||'').replace(/[^0-9.]/g,''));
        if (!a.floorArea || isNaN(num(a.floorArea)) || num(a.floorArea)<=0) e.floorArea = 'Enter a valid floor area';
        if (a.yearBuilt && (num(a.yearBuilt) < 1900 || num(a.yearBuilt) > new Date().getFullYear())) e.yearBuilt = 'Enter a valid year';
        if (!a.annualKwh || isNaN(num(a.annualKwh)) || num(a.annualKwh)<=0) e.annualKwh = 'Enter annual kWh';
        setErrors(e); return Object.keys(e).length===0;
      }

      function generateApva(){
        if (!validateAudit(audit)) { alert('Please fix highlighted fields.'); return; }
        setApvaStatus('Submitted'); setApvaPdfReady(false);
        // make a real PDF
        const doc = new jsPDF();
        doc.setFontSize(16); doc.text('APVA Grant Application – EcoRetrofit24 (Draft)', 14, 18);
        doc.setFontSize(11); doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 26);
        doc.text('Applicant: EcoRetrofit UAB', 14, 34);
        doc.text('Property Details', 14, 46);
        doc.setFont('courier','normal');
        doc.text(`• Building Type: ${audit.buildingType}`, 16, 54);
        doc.text(`• Floor Area (m²): ${audit.floorArea || '-'}`, 16, 60);
        doc.text(`• Year Built: ${audit.yearBuilt || '-'}`, 16, 66);
        doc.text(`• Heating: ${audit.heating || '-'}`, 16, 72);
        doc.text(`• Annual kWh: ${audit.annualKwh || '-'}`, 16, 78);
        doc.setFont('helvetica',''); doc.text('Attachments Checklist', 14, 94);
        doc.setFont('courier',''); doc.text('• Ownership proof\n• Energy audit baseline\n• Contractor quotes\n• Budget & financing plan', 16, 102);
        const url = doc.output('bloburl'); setApvaUrl(url);
        setTimeout(()=>{ setApvaStatus('Approved'); setApvaPdfReady(true); }, 700);
      }

      /* AI demo (simulated) */
      const [aiLoading, setAiLoading] = useState(false);
      const [aiRecs, setAiRecs] = useState([]);
      const [aiPred, setAiPred] = useState(null);
      useEffect(() => {
        if (audit.floorArea && audit.yearBuilt && audit.heating){
          setAiLoading(true);
          setTimeout(() => {
            const area = Number((audit.floorArea||'0').replace(/[^0-9.]/g,''));
            const baseSavings = area ? Math.min(45, 10 + Math.round(area/300)) : 25;
            setAiRecs([
              area>150 && 'Install solar – est. 25% electricity reduction',
              (audit.yearBuilt||0) < 1990 && 'Upgrade insulation – potential 30% savings',
              /gas/i.test(audit.heating||'') && 'Heat pump could reduce heating cost by up to 40%',
            ].filter(Boolean));
            setAiPred({ energySavings: baseSavings, costSavings: baseSavings*120, roi: Math.max(12, Math.round(10000/((baseSavings*120)/12))) });
            setAiLoading(false);
          }, 800);
        }
      }, [audit.floorArea, audit.yearBuilt, audit.heating]);

      return (
        <div>
          {/* Header */}
          <div className="header">
            <!-- Replace with your logo file at /logo.png -->
            <img src="logo.png" alt="EcoRetrofit logo" style={{height:40,width:'auto',borderRadius:8}} onError={(e)=>{ e.currentTarget.replaceWith(Object.assign(document.createElement('div'),{className:'logo-fallback',textContent:'ER'})); }} />
            <div>
              <div className="title">EcoRetrofit24 • MVP Prototype</div>
              <div className="sub">APVA automation • Retrofit workflow • KPI reporting • Prototype • Sample data</div>
            </div>
            <div style={{ marginLeft:'auto', display:'flex', gap:10 }}>
              <button className="btn-outline" aria-label="Open settings">Settings</button>
              <button className="btn-ai" aria-label="Open AI assistant">AI Assistant</button>
            </div>
          </div>

          {/* Tabs */}
          <div className="tab-bar" role="tablist" aria-label="Main sections">
            {[
              { id:'audit', label:'Audit Form' },
              { id:'apva', label:'APVA Generator' },
              { id:'projects', label:'Projects' },
              { id:'reporting', label:'Reporting' },
              { id:'ai', label:'AI Insights' },
            ].map(t => (
              <button
                key={t.id}
                role="tab"
                aria-selected={activeTab===t.id}
                onClick={()=>setActiveTab(t.id)}
                className={activeTab===t.id ? `tab tab-active ${t.id==='ai'?'ai-tab':''}` : 'tab'}
              >
                {t.label}
              </button>
            ))}
          </div>

          {/* Content */}
          <div className="content">
            {activeTab==='audit' && (
              <div className="grid-3">
                <Section title="Building Details" action={<span className='pill'>Draft</span>}>
                  <div className="grid-2">
                    <Field label="Building Type">
                      <select aria-label="Building type" value={audit.buildingType} onChange={e=>setAudit({...audit,buildingType:e.target.value})} className="input">
                        <option>Single</option>
                        <option>Multi-apartment</option>
                        <option>Commercial</option>
                      </select>
                    </Field>
                    <Field label="Floor Area (m²)">
                      <input aria-label="Floor area in square meters" className="input" placeholder="e.g., 1,250" value={audit.floorArea} onChange={e=>setAudit({...audit,floorArea:e.target.value})} />
                      {errors.floorArea && <div className='err'>{errors.floorArea}</div>}
                    </Field>
                    <Field label="Year of Construction">
                      <input aria-label="Year built" className="input" placeholder="e.g., 1998" value={audit.yearBuilt} onChange={e=>setAudit({...audit,yearBuilt:e.target.value})} />
                      {errors.yearBuilt && <div className='err'>{errors.yearBuilt}</div>}
                    </Field>
                    <Field label="Heating System">
                      <input aria-label="Heating type" className="input" placeholder="District / Gas / Electric" value={audit.heating} onChange={e=>setAudit({...audit,heating:e.target.value})} />
                    </Field>
                    <Field label="Annual Energy Usage (kWh)">
                      <input aria-label="Annual energy in kWh" className="input" placeholder="e.g., 185,000" value={audit.annualKwh} onChange={e=>setAudit({...audit,annualKwh:e.target.value})} />
                      {errors.annualKwh && <div className='err'>{errors.annualKwh}</div>}
                    </Field>
                    <Field label="Notes / Observations" full>
                      <textarea aria-label="Notes" className="input" rows="4" placeholder="Thermal bridges, roof condition, window glazing, etc." value={audit.notes} onChange={e=>setAudit({...audit,notes:e.target.value})}></textarea>
                    </Field>
                  </div>
                  <div className="btn-group">
                    <button
                      className="btn-primary"
                      aria-label="Generate APVA PDF"
                      onClick={()=>{ setActiveTab('apva'); setTimeout(generateApva, 0); }}
                    >
                      Generate APVA PDF
                    </button>
                    <button className="btn-outline" aria-label="Save draft" onClick={()=>alert('Saved locally')}>Save Draft</button>
                  </div>
                </Section>

                <Section title="Quick Estimator">
                  <EstimatorCard audit={audit} />
                </Section>

                <Section title="Document Checklist">
                  <ul className="list">
                    <li>Ownership proof</li>
                    <li>Energy audit baseline</li>
                    <li>Contractor quotes</li>
                    <li>Budget & financing plan</li>
                  </ul>
                </Section>
              </div>
            )}

            {activeTab==='apva' && (
              <Section title="APVA Application Status" action={<span className='pill'>{apvaStatus}</span>}>
                <div className="grid-apva">
                  <div>
                    <div className="steps-row">
                      <Step done={apvaStatus!=='Draft'} label="Draft" />
                      <div className="step-line" />
                      <Step done={apvaStatus!=='Draft'} label="Submitted" />
                      <div className="step-line" />
                      <Step done={apvaStatus==='Approved'} label="Approved" />
                    </div>
                    <div className="box">
                      <p className="muted">Generate APVA-compliant PDF using the audit fields. This mock simulates server-side generation.</p>
                      <div className="btn-group">
                        <button className="btn-primary" aria-label="Generate PDF" onClick={generateApva}>Generate PDF</button>
                        {apvaPdfReady ? (
                          <a className="btn-outline" aria-label="Download PDF" href={apvaUrl} download="APVA-Application.pdf">Download PDF</a>
                        ) : (
                          <button className="btn-outline" aria-label="Download PDF disabled" disabled>Download PDF</button>
                        )}
                      </div>
                    </div>
                  </div>
                  <div>
                    <div className="box" style={{background:'#f0fdfa', borderColor:'#99f6e4'}}>
                      <p style={{ margin:0, fontSize:14 }}><b>Tip:</b> Attach contractor quotes and HOA mandate to improve approval chances.</p>
                    </div>
                    <div style={{ marginTop:16 }}>
                      <div style={{ fontSize:14, marginBottom:8, fontWeight:'600' }}>APVA Checklist</div>
                      <ul className="list">
                        <li>Applicant & Property details</li>
                        <li>Baseline energy audit</li>
                        <li>Measures & expected savings</li>
                        <li>Budget & financing plan</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </Section>
            )}

            {activeTab==='projects' && (
              <Section title="Project Pipeline (Kanban)">
                <div style={{ marginBottom:12 }}>
                  <input className="input" placeholder="Search projects..." value={projectQuery} onChange={e=>setProjectQuery(e.target.value)} />
                </div>
                <div className="kanban">
                  {stages.map(stage => (
                    <div key={stage} className="kanban-col">
                      <div className="kanban-col-head">
                        <div className="col-title" style={{ fontWeight:600 }}>{stage}</div>
                        <div className="badge-light">{filtered.filter(p=>p.stage===stage).length}</div>
                      </div>
                      <div>
                        {filtered.filter(p=>p.stage===stage).map(p => (
                          <div key={p.id} className="card-sm">
                            <div className="card-title" style={{ fontWeight:600 }}>{p.addr}</div>
                            <Progress value={p.pct} />
                            <div className="mini-text">{p.pct}% complete</div>
                            <div style={{ display:'flex', gap:8, marginTop:12 }}>
                              <button className="btn-outline" aria-label={`View ${p.addr}`} style={{ padding:'6px 12px', fontSize:12 }}>View</button>
                              <button className="btn-primary" aria-label={`Advance ${p.addr}`} style={{ padding:'6px 12px', fontSize:12 }}>Advance</button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </Section>
            )}

            {activeTab==='reporting' && (
              <div className="grid-3">
                <Section title="Energy Savings Trend">
                  {R.LineChart ? (
                    <div className="chart-container">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={kpiData} margin={{ top:10, right:10, left:0, bottom:0 }}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="month" />
                          <YAxis />
                          <Tooltip />
                          <Line type="monotone" dataKey="savings" stroke="#0d9488" strokeWidth={2} dot={false} />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>
                  ) : (
                    <div style={{ padding:20, textAlign:'center', color:'#64748b' }}>Chart library not loaded. Check console for errors.</div>
                  )}
                </Section>

                <Section title="Project Mix (YTD)">
                  {R.PieChart ? (
                    <div className="chart-container">
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie dataKey="value" data={mix} innerRadius={45} outerRadius={80} paddingAngle={3}>
                            {mix.map((_,i)=>(<Cell key={i} fill={["#10b981","#34d399","#6ee7b7","#a7f3d0"][i%4]} />))}
                          </Pie>
                          <Tooltip />
                        </PieChart>
                      </ResponsiveContainer>
                    </div>
                  ) : (
                    <div style={{ padding:20, textAlign:'center', color:'#64748b' }}>Chart library not loaded. Check console for errors.</div>
                  )}
                </Section>

                <Section title="Approvals (YTD)">
                  {R.BarChart ? (
                    <div className="chart-container">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={kpiData}>
                          <CartesianGrid strokeDasharray="3 3" />
                          <XAxis dataKey="month" />
                          <YAxis />
                          <Tooltip />
                          <Bar dataKey="approvals" fill="#10b981" radius={[6,6,0,0]} />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  ) : (
                    <div style={{ padding:20, textAlign:'center', color:'#64748b' }}>Chart library not loaded. Check console for errors.</div>
                  )}
                </Section>

                <div style={{ gridColumn:'1 / -1' }}>
                  <Section title="Battery Spotlight">
                    <BatterySpotlight />
                  </Section>
                </div>
              </div>
            )}

            {activeTab==='ai' && (
              <div className="grid-3">
                <Section title="AI Energy Advisor" action={<span className='badge'>AI Powered</span>}>
                  {aiLoading ? (
                    <div style={{ textAlign:'center', padding:20 }}>
                      <div style={{ display:'inline-block', width:16, height:16, border:'2px solid rgba(13,148,136,.3)', borderTopColor:'#0d9488', borderRadius:'50%', animation:'spin 1s linear infinite' }} />
                      <p className="muted">AI is analyzing your building data...</p>
                    </div>
                  ) : aiRecs.length ? (
                    <div className="ai-reco">
                      <div className="ai-h"><span>🤖</span> AI Recommendations</div>
                      <ul className="list" style={{ listStyle:'none', paddingLeft:0 }}>
                        {aiRecs.map((r,i)=>(<li key={i} style={{ padding:'10px', marginBottom:8, background:'rgba(255,255,255,.7)', borderRadius:8, borderLeft:'3px solid #8b5cf6' }}>{r}</li>))}
                      </ul>
                      <button className="btn-ai" style={{ width:'100%', marginTop:12 }}>Generate Detailed Report</button>
                    </div>
                  ) : (
                    <div>
                      <p className="muted">Enter your building details (Audit tab) to get AI-powered recommendations.</p>
                    </div>
                  )}

                  <div className="ai-pred">
                    <div className="section-title" style={{ color:'#0f766e' }}>AI Savings Forecast</div>
                    {aiPred ? (
                      <div className="metric-grid">
                        <Metric label="Energy Savings" value={`${aiPred.energySavings}%`} />
                        <Metric label="Annual Savings" value={`€${aiPred.costSavings}`} />
                        <Metric label="ROI Period" value={`${aiPred.roi} months`} />
                        <Metric label="AI Confidence" value={`92%`} />
                      </div>
                    ) : (
                      <p className="muted">Complete the audit form to see forecast.</p>
                    )}
                  </div>
                </Section>
              </div>
            )}
          </div>

          <div className="footer">© {new Date().getFullYear()} EcoRetrofit UAB · Prototype build. Sample data. No backend or personal data processed.</div>
        </div>
      );
    }

    function EstimatorCard({ audit }){
      const area = Number((audit.floorArea||'0').replace(/[^0-9.]/g,''));
      const base = Math.max(10000, Math.min(200000, area * 90));
      const savingsPct = area ? Math.min(45, 10 + Math.round(area/300)) : 25;
      const paybackMonths = Math.max(12, 84 - Math.round(savingsPct));
      return (
        <div>
          <p className="muted">Quick, non-binding estimate based on inputs.</p>
          <div className="metric-grid">
            <Metric label="Est. Ticket" value={`€${base.toLocaleString()}`} />
            <Metric label="Savings" value={`${savingsPct}%`} />
            <Metric label="Payback" value={`${paybackMonths} mo`} />
            <Metric label="Grant (up to)" value={`€${Math.round(base * 0.85).toLocaleString()}`} />
          </div>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>

  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</body>
</html>
