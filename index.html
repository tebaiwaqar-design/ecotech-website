import React, { useMemo, useState } from "react";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar } from "recharts";

// Minimal, no-shadcn / no-tailwind version.
// Dependencies: react, react-dom, recharts
// Run (Vite quick start):
//   npm create vite@latest eco-demo -- --template react
//   cd eco-demo && npm i recharts && npm i
//   replace App.jsx with this file's default export usage (see bottom)
//   npm run dev

export default function EcoRetrofitDemo() {
  const [activeTab, setActiveTab] = useState("audit");

  // Audit form state
  const [audit, setAudit] = useState({
    buildingType: "Single",
    floorArea: "",
    yearBuilt: "",
    heating: "",
    annualKwh: "",
    notes: "",
  });

  const [apvaStatus, setApvaStatus] = useState("Draft");
  const [apvaPdfReady, setApvaPdfReady] = useState(false);

  const demoProjects = [
    { id: 1, addr: "125 Oak St.", stage: "Intake", pct: 18 },
    { id: 2, addr: "789 Birch Ave.", stage: "Audit", pct: 42 },
    { id: 3, addr: "790 Dack Ave.", stage: "Proposal", pct: 58 },
    { id: 4, addr: "123 Oak St.", stage: "Install", pct: 76 },
    { id: 5, addr: "781 5th Ave.", stage: "QC", pct: 88 },
    { id: 6, addr: "117 9th Ave.", stage: "Rebate", pct: 100 },
  ];
  const stages = ["Intake", "Audit", "Proposal", "Install", "QC", "Rebate"];

  const kpiData = [
    { month: "Jan", savings: 12, approvals: 2 },
    { month: "Feb", savings: 15, approvals: 3 },
    { month: "Mar", savings: 18, approvals: 4 },
    { month: "Apr", savings: 22, approvals: 5 },
    { month: "May", savings: 27, approvals: 6 },
    { month: "Jun", savings: 31, approvals: 7 },
  ];

  const mix = [
    { name: "Solar", value: 40 },
    { name: "Heat Pumps", value: 32 },
    { name: "Insulation", value: 18 },
    { name: "Batteries", value: 10 },
  ];

  const filteredByStage = useMemo(
    () => stages.map((s) => ({ stage: s, items: demoProjects.filter((p) => p.stage === s) })),
    []
  );

  const generateApva = () => {
    setApvaStatus("Submitted");
    setApvaPdfReady(false);
    setTimeout(() => {
      setApvaStatus("Approved");
      setApvaPdfReady(true);
    }, 800);
  };

  const styles = getStyles();

  return (
    <div style={styles.page}>
      {/* Header */}
      <div style={styles.header}>
        <div style={styles.logo}>ER</div>
        <div>
          <div style={styles.title}>EcoRetrofit24 • MVP Prototype</div>
          <div style={styles.sub}>APVA automation • Retrofit workflow • KPI reporting</div>
        </div>
        <div style={{ marginLeft: "auto", display: "flex", gap: 8 }}>
          <button style={styles.btnOutline}>Settings</button>
          <button style={styles.btnPrimary}>Request Demo</button>
        </div>
      </div>

      {/* Tabs */}
      <div style={styles.tabBar}>
        {[
          { id: "audit", label: "Audit Form" },
          { id: "apva", label: "APVA Generator" },
          { id: "projects", label: "Projects" },
          { id: "reporting", label: "Reporting" },
        ].map((t) => (
          <button
            key={t.id}
            onClick={() => setActiveTab(t.id)}
            style={{
              ...styles.tab,
              ...(activeTab === t.id ? styles.tabActive : null),
            }}
          >
            {t.label}
          </button>
        ))}
      </div>

      {/* Content */}
      {activeTab === "audit" && (
        <div style={styles.grid3}>
          <Section title="Building Details" action={<Pill>Draft</Pill>}>
            <div style={styles.grid2}>
              <Field label="Building Type">
                <select
                  value={audit.buildingType}
                  onChange={(e) => setAudit({ ...audit, buildingType: e.target.value })}
                  style={styles.input}
                >
                  <option>Single</option>
                  <option>Multi-apartment</option>
                  <option>Commercial</option>
                </select>
              </Field>
              <Field label="Floor Area (m²)">
                <input
                  placeholder="e.g., 1,250"
                  value={audit.floorArea}
                  onChange={(e) => setAudit({ ...audit, floorArea: e.target.value })}
                  style={styles.input}
                />
              </Field>
              <Field label="Year of Construction">
                <input
                  placeholder="e.g., 1998"
                  value={audit.yearBuilt}
                  onChange={(e) => setAudit({ ...audit, yearBuilt: e.target.value })}
                  style={styles.input}
                />
              </Field>
              <Field label="Heating System">
                <input
                  placeholder="District / Gas / Electric"
                  value={audit.heating}
                  onChange={(e) => setAudit({ ...audit, heating: e.target.value })}
                  style={styles.input}
                />
              </Field>
              <Field label="Annual Energy Usage (kWh)">
                <input
                  placeholder="e.g., 185,000"
                  value={audit.annualKwh}
                  onChange={(e) => setAudit({ ...audit, annualKwh: e.target.value })}
                  style={styles.input}
                />
              </Field>
              <Field label="Notes / Observations" full>
                <textarea
                  rows={4}
                  placeholder="Thermal bridges, roof condition, window glazing, etc."
                  value={audit.notes}
                  onChange={(e) => setAudit({ ...audit, notes: e.target.value })}
                  style={{ ...styles.input, resize: "vertical", height: 96 }}
                />
              </Field>
            </div>
            <div style={{ marginTop: 12, display: "flex", gap: 8 }}>
              <button style={styles.btnPrimary} onClick={() => setActiveTab("apva")}>
                Generate APVA PDF
              </button>
              <button style={styles.btnOutline}>Save Draft</button>
            </div>
          </Section>

          <Section title="Quick Estimator">
            <EstimatorCard audit={audit} />
          </Section>

          <Section title="Document Checklist">
            <ul style={styles.list}>
              <li>Ownership proof</li>
              <li>Energy audit baseline</li>
              <li>Contractor quotes</li>
              <li>Payback & savings model</li>
            </ul>
            <div style={{ marginTop: 8, fontSize: 13 }}>
              <span style={styles.badge}>APVA</span> Grant coverage up to 85%
            </div>
          </Section>
        </div>
      )}

      {activeTab === "apva" && (
        <Section title="APVA Application Status" action={<Pill>{apvaStatus}</Pill>}>
          <div style={styles.gridApva}>
            <div>
              <div style={styles.stepsRow}>
                <Step done={apvaStatus !== "Draft"} label="Draft" />
                <div style={styles.stepLine} />
                <Step done={apvaStatus !== "Draft"} label="Submitted" />
                <div style={styles.stepLine} />
                <Step done={apvaStatus === "Approved"} label="Approved" />
              </div>
              <div style={styles.box}>
                <p style={styles.muted}>Generate APVA-compliant PDF using the audit fields. This mock simulates server-side generation.</p>
                <div style={{ marginTop: 12, display: "flex", gap: 8 }}>
                  <button style={styles.btnPrimary} onClick={generateApva}>Generate PDF</button>
                  <button style={styles.btnOutline} disabled={!apvaPdfReady}>Download PDF</button>
                </div>
              </div>
            </div>
            <div>
              <div style={{ ...styles.box, background: "#ecfdf5" }}>
                <p style={{ margin: 0, fontSize: 14 }}><b>Tip:</b> Attach contractor quotes and HOA mandate to improve approval chances.</p>
              </div>
              <div style={{ marginTop: 12 }}>
                <div style={{ fontSize: 13, marginBottom: 6 }}>APVA Checklist</div>
                <ul style={styles.list}>
                  <li>Applicant & Property details</li>
                  <li>Baseline energy audit</li>
                  <li>Measures & expected savings</li>
                  <li>Budget & financing plan</li>
                </ul>
              </div>
            </div>
          </div>
        </Section>
      )}

      {activeTab === "projects" && (
        <Section title="Project Pipeline (Kanban)">
          <div style={styles.kanban}>
            {stages.map((stage) => (
              <div key={stage} style={styles.kanbanCol}>
                <div style={styles.kanbanColHead}>
                  <div style={{ fontWeight: 600 }}>{stage}</div>
                  <div style={styles.badgeLight}>{demoProjects.filter((p) => p.stage === stage).length}</div>
                </div>
                <div>
                  {demoProjects.filter((p) => p.stage === stage).map((p) => (
                    <div key={p.id} style={styles.cardSm}>
                      <div style={{ fontSize: 14, fontWeight: 600 }}>{p.addr}</div>
                      <Progress value={p.pct} />
                      <div style={styles.miniText}>{p.pct}% complete</div>
                      <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                        <button style={styles.btnTinyOutline}>View</button>
                        <button style={styles.btnTinyPrimary}>Advance</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </Section>
      )}

      {activeTab === "reporting" && (
        <div style={styles.grid3}>          
          <Section title="Energy Savings Trend">
            <div style={{ height: 260 }}>
              <ResponsiveContainer width="100%" height="100%">
                <LineChart data={kpiData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="month" />
                  <YAxis />
                  <Tooltip />
                  <Line type="monotone" dataKey="savings" stroke="#059669" strokeWidth={2} dot={false} />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </Section>

          <Section title="Project Mix (YTD)">
            <div style={{ height: 260 }}>
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie dataKey="value" data={mix} innerRadius={45} outerRadius={80} paddingAngle={3}>
                    {mix.map((_, i) => (
                      <Cell key={i} fill={["#10b981", "#34d399", "#6ee7b7", "#a7f3d0"][i % 4]} />
                    ))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </Section>

          <Section title="Approvals (YTD)">
            <div style={{ height: 260 }}>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={kpiData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="month" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="approvals" fill="#10b981" radius={[6, 6, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </Section>
        </div>
      )}

      {/* Footer */}
      <div style={styles.footer}>© {new Date().getFullYear()} EcoRetrofit UAB · Prototype UI for demonstrations. No backend or personal data processed.</div>
    </div>
  );
}

// --- UI primitives (no external UI lib) ---
function Section({ title, action, children }) {
  const s = getStyles();
  return (
    <div style={s.section}>
      <div style={s.sectionHead}>
        <div style={{ fontSize: 18, fontWeight: 600 }}>{title}</div>
        {action}
      </div>
      <div>{children}</div>
    </div>
  );
}

function Pill({ children }) {
  const s = getStyles();
  return <span style={s.pill}>{children}</span>;
}

function Field({ label, full, children }) {
  const s = getStyles();
  return (
    <div style={{ gridColumn: full ? "1 / -1" : undefined }}>
      <div style={s.label}>{label}</div>
      {children}
    </div>
  );
}

function Progress({ value }) {
  const s = getStyles();
  return (
    <div style={s.progressOuter}>
      <div style={{ ...s.progressInner, width: `${value}%` }} />
    </div>
  );
}

// --- Styles ---
function getStyles() {
  return {
    page: { fontFamily: "Inter, system-ui, Arial", background: "#fafafa", color: "#111", minHeight: "100vh" },
    header: { display: "flex", alignItems: "center", gap: 12, padding: "12px 16px", borderBottom: "1px solid #e5e7eb", background: "#fff", position: "sticky", top: 0, zIndex: 10 },
    logo: { height: 36, width: 36, borderRadius: 12, background: "#059669", color: "#fff", display: "grid", placeItems: "center", fontWeight: 700 },
    title: { fontSize: 18, fontWeight: 600 },
    sub: { fontSize: 12, color: "#6b7280" },

    tabBar: { display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 8, padding: 16 },
    tab: { padding: "10px 12px", border: "1px solid #e5e7eb", background: "#fff", borderRadius: 12, cursor: "pointer" },
    tabActive: { background: "#059669", color: "#fff", borderColor: "#059669" },

    grid3: { display: "grid", gridTemplateColumns: "2fr 1fr 1fr", gap: 12, padding: "0 16px 16px" },
    grid2: { display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 },

    section: { background: "#fff", border: "1px solid #e5e7eb", borderRadius: 16, padding: 16, boxShadow: "0 1px 2px rgba(0,0,0,0.03)" },
    sectionHead: { display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 12 },
    label: { fontSize: 12, color: "#6b7280", marginBottom: 6 },

    input: { width: "100%", border: "1px solid #e5e7eb", borderRadius: 10, padding: "10px 12px", fontSize: 14, outline: "none" },

    btnPrimary: { background: "#059669", color: "#fff", border: "1px solid #059669", borderRadius: 999, padding: "10px 14px", cursor: "pointer", fontWeight: 600 },
    btnOutline: { background: "#fff", color: "#059669", border: "1px solid #059669", borderRadius: 999, padding: "10px 14px", cursor: "pointer", fontWeight: 600 },

    badge: { display: "inline-block", padding: "2px 8px", background: "#059669", color: "#fff", borderRadius: 999, marginRight: 6, fontSize: 12, fontWeight: 600 },
    badgeLight: { display: "inline-block", padding: "2px 8px", background: "#f3f4f6", color: "#111", borderRadius: 999, fontSize: 12, fontWeight: 600 },

    list: { fontSize: 14, color: "#374151", paddingLeft: 18 },
    muted: { fontSize: 13, color: "#6b7280", margin: 0 },

    gridApva: { display: "grid", gridTemplateColumns: "2fr 1fr", gap: 16 },
    stepsRow: { display: "flex", alignItems: "center", gap: 8, marginBottom: 12 },
    stepLine: { flex: 1, height: 1, background: "#d1fae5" },
    box: { border: "1px solid #e5e7eb", borderRadius: 12, padding: 12, background: "#fff" },

    kanban: { display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: 12 },
    kanbanCol: { border: "1px solid #e5e7eb", borderRadius: 16, padding: 12, background: "#fff" },
    kanbanColHead: { display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 },
    cardSm: { border: "1px solid #e5e7eb", borderRadius: 12, padding: 12, background: "#fff", marginBottom: 8, boxShadow: "0 1px 2px rgba(0,0,0,0.03)" },
    miniText: { marginTop: 6, fontSize: 12, color: "#6b7280" },

    progressOuter: { width: "100%", height: 8, background: "#f3f4f6", borderRadius: 999, overflow: "hidden", marginTop: 8 },
    progressInner: { height: "100%", background: "#10b981" },

    footer: { padding: 16, fontSize: 12, color: "#6b7280" },
  };
}

function Step({ done, label }) {
  const s = getStyles();
  return (
    <div style={{ display: "flex", alignItems: "center", gap: 6, color: done ? "#065f46" : "#9ca3af" }}>
      <div
        style={{
          height: 24,
          width: 24,
          borderRadius: 999,
          display: "grid",
          placeItems: "center",
          border: `1px solid ${done ? "#059669" : "#e5e7eb"}`,
          background: done ? "#059669" : "#fff",
          color: done ? "#fff" : "#6b7280",
          fontSize: 12,
          fontWeight: 700,
        }}
      >
        {done ? "✓" : label[0]}
      </div>
      <span style={{ fontSize: 14 }}>{label}</span>
    </div>
  );
}

function EstimatorCard({ audit }) {
  const area = Number((audit.floorArea || "0").replace(/[^0-9.]/g, ""));
  const base = Math.max(10000, Math.min(200000, area * 90));
  const savingsPct = area ? Math.min(45, 10 + Math.round(area / 300)) : 25;
  const paybackMonths = Math.max(12, 84 - Math.round(savingsPct));

  const s = getStyles();
  return (
    <div>
      <div style={s.muted}>Quick, non-binding estimate based on inputs.</div>
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginTop: 8 }}>
        <Metric label="Est. Ticket" value={`€${base.toLocaleString()}`} />
        <Metric label="Savings" value={`${savingsPct}%`} />
        <Metric label="Payback" value={`${paybackMonths} mo`} />
        <Metric label="Grant (up to)" value={`€${Math.round(base * 0.85).toLocaleString()}`} />
      </div>
    </div>
  );
}

function Metric({ label, value }) {
  const s = getStyles();
  return (
    <div style={{ border: "1px solid #e5e7eb", borderRadius: 12, padding: 12, background: "#fff" }}>
      <div style={{ fontSize: 12, color: "#6b7280" }}>{label}</div>
      <div style={{ fontSize: 18, fontWeight: 600 }}>{value}</div>
    </div>
  );
}

// USAGE (Vite):
// In main.jsx:
//   import React from 'react'
//   import ReactDOM from 'react-dom/client'
//   import EcoRetrofitDemo from './EcoRetrofitDemo.jsx'
//   ReactDOM.createRoot(document.getElementById('root')).render(
//     <React.StrictMode>
//       <EcoRetrofitDemo />
//     </React.StrictMode>,
//   )
